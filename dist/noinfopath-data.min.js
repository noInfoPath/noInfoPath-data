noInfoPath=noInfoPath||{},noInfoPath.data={},function(angular,undefined){"use strict";angular.module("noinfopath.data",["ngLodash","noinfopath.helpers"]).run(["$injector","$parse","$timeout","$q","$rootScope","$browser",function($injector,$parse,$timeout,$q,$rootScope,$browser){function _digestTimeout(){$timeout.flush&&$browser.deferredFns.length&&($rootScope.$$phase?setTimeout(function(){$timeout.flush()},10):$timeout.flush())}function _digestError(fn,error){var digestError=error;angular.isObject(error)&&(digestError=error.toString()),_digest(fn,digestError)}function _digest(fn,data){var message=[];message=angular.isArray(data)?data:[data],window.jasmine?($timeout(function(){fn.apply(null,message)}),$timeout.flush()):fn.apply(null,message)}function _setItem(store,key,value){var getter=$parse(key),setter=getter.assign;setter(store,value)}function _getItem(store,key){var getter=$parse(key);return getter(store)}function _noFilterExpression(type,key,operator,match,logic){this.type=type||"indexed",this.field=key,this.operator=operator,this.value=match,this.logic=logic}function _noFilter(table){var _table=table,_filters=[],_logic="and";Object.defineProperties(this,{filters:{get:function(){return _filters}},logic:{get:function(){return _logic},set:function(value){_logic=value}}}),this.__proto__.type="noFilter",this.__proto__.add=function(key,operator,match,logic){var k,o,m,l;if(angular.isObject(key)?(k=key.field,o=key.operator,m=key.value,l="and"):(k=key,o=operator,m=match,l=logic),_table)var index=_table.schema.indexes.filter(function(a){return a.name===k}),isIndexed=1==index.length||_table.schema.primKey.name===k,type=isIndexed?"indexed":"filtered";else type="odata";_filters.push(new window.noInfoPath.noFilterExpression(type,k,o,m,l))}}function _noDataReadRequest(table,options){var deferred=$q.defer(),_table=table;if(Object.defineProperties(this,{__type:{get:function(){return"noDataReadRequest"}},promise:{get:function(){return deferred.promise}}}),this.__proto__.addFilter=function(key,operator,match,logic){this.data.filter===undefined&&(this.data.filter=new window.noInfoPath.noFilter(_table)),this.data.filter.add(key,operator,match,logic)},this.__proto__.removeFilter=function(indexOf){this.data.filter&&(delete this.data.filter[indexOf],0===this.data.filter.length&&delete this.data.filter)},this.__proto__.indexOfFilter=function(key){if(this.data.filter===undefined)return-1;for(var i in this.data.filter){var f=this.data.filter[i];if(f.key===key)return Number(i)}return-1},this.__proto__.addSort=function(sort){this.data.sort===undefined&&(this.data.sort=[]),this.data.sort.push(sort)},this.__proto__.removeSort=function(indexOf){this.data.sort&&(delete this.data.sort[indexOf],0===this.data.sort.length&&delete this.data.sort)},this.__proto__.indexOfSort=function(key){if(this.data.sort===undefined)return-1;for(var i in this.data.sort){var f=this.data.sort[i];if(f.key===key)return Number(i)}return-1},options){if(this.data={filter:undefined,page:undefined,pageSize:undefined,sort:undefined,skip:undefined,take:undefined},angular.extend(this.data,options.data),this.data.filter){var tmp=new window.noInfoPath.noFilter(table);angular.forEach(this.data.filter.filters,function(filter){tmp.add(filter)},this),this.data.filter=tmp}}else this.data={filter:undefined,page:undefined,pageSize:undefined,sort:undefined,skip:undefined,take:undefined};this.__proto__.success=deferred.resolve,this.__proto__.error=deferred.reject,this.expand=options.expand,this.projections=options.projections,this.aggregators=options.aggregators}function _noDataSource(component,config,stateParams,scope){var service=$injector.get(component),provider=$injector.get(config.provider),ds=service.noDataSource(config.tableName,provider,config);if(ds.expand=config.expand||undefined,ds.projections=config.projections,ds.aggregators=config.aggregators,config.sort&&(ds.sort=config.sort),config.filter){var _filters=[];angular.forEach(config.filter,function(fltr){if(angular.isObject(fltr.value)){var source;source="state"===fltr.value.source?stateParams:scope;var val=window.noInfoPath.getItem(source,fltr.value.property);val="number"===fltr.value.type?Number(val):val,_filters.push({field:fltr.field,operator:fltr.operator,value:val})}else _filters.push({field:fltr.field,operator:fltr.operator,value:fltr.value})}),ds.filter=_filters}angular.extend(this,ds)}function _makeFilters(filters,scope,stateParams){var _filters=[];return angular.forEach(filters,function(filter){var ctx,v;if(angular.isObject(filter.value)){switch(filter.value.source){case"state":ctx=stateParams;break;case"scope":ctx=scope}v=window.noInfoPath.getItem(ctx,filter.value.property),v&&(v="number"===filter.value.type?Number(v):v,_filters.push({field:filter.field,operator:filter.operator,value:v}))}else _filters.push(filter)}),_filters}var _data={getItem:_getItem,setItem:_setItem,bindFilters:_makeFilters,noFilterExpression:_noFilterExpression,noFilter:_noFilter,noDataReadRequest:_noDataReadRequest,noDataSource:_noDataSource,digest:_digest,digestError:_digestError,digestTimeout:_digestTimeout};window.noInfoPath=angular.extend(window.noInfoPath||{},_data)}]).service("noDataService",["$q",function($q){this.noDataSource=function(uri,datasvc,options){function _noHTTP(){return{transport:{read:function(options){return datasvc.read(uri,options)},create:function(options){return datasvc.create(uri,options)},update:function(options){return datasvc.update(uri,options)},destroy:function(options){return crudOp(_ds,"destroy",options)},one:function(options){return datasvc.read(uri,options).then(function(data){return data.length>0?data[0]:{}})},upsert:function(options){return console.warn("TODO: implement noHTTP upsert"),datasvc.update(uri,options)}}}}function _noIndexedDB(){function crudOp(table,operation,options){var crud=table.noCRUD,ndrr=new window.noInfoPath.noDataReadRequest(table,options);return crud[operation](ndrr)}if(!uri)throw"uri is a required parameter for makeKendoDataSource";var _ds=datasvc[uri];return{transport:{read:function(options){var deferred=_ds.noCRUD.$q.defer();return crudOp(_ds,"read",options).then(function(data){this.data=data,deferred.resolve(data)}.bind(this)),deferred.promise},create:function(options){return crudOp(_ds,"create",options)},update:function(options){return crudOp(_ds,"update",options)},destroy:function(options){return crudOp(_ds,"destroy",options)},one:function(options){return _ds.noCRUD.one(options)},upsert:function(options){return _ds.noCRUD.upsert(options)}},table:_ds,data:[],expand:options.expand,projections:options.projections,aggregators:options.aggregators}}var ds;return ds="NoInfoPath-v3"==datasvc.name?_noIndexedDB():_noHTTP()}}])}(angular),function(angular,undefined){"use strict";function NoFilterExpression(column,operator,value,logic){if(!column)throw"INoFilterExpression requires a column to filter on.";if(!operator)throw"INoFilterExpression requires a operator to filter by.";if(!value)throw"INoFilterExpression requires a value(s) to filter for.";this.column=column,this.operator=operator,this.value=value,this.logic=logic}function NoFilters(){Object.defineProperties(this,{__type:{get:function(){return"NoFilters"}}})}function NoSortExpression(column,dir){if(!column)throw"NoFilters::add requires a column to sort on.";this.column=column,this.dir=dir}function NoSort(){var arr=[];Object.defineProperties(arr,{__type:{get:function(){return"NoSort"}}}),arr.push.apply(arr,arguments),arr.add=function(column,dir){if(!column)throw"NoSort::add requires a column to filter on.";this.push(new NoSortExpression(column,dir))},noInfoPath.setPrototypeOf(this,arr)}function NoPage(skip,take){this.skip=skip,this.take=take}NoFilters.prototype=Object.create(Array.prototype),NoFilters.prototype.add=function(column,operator,value,logic){if(!column)throw"NoFilters::add requires a column to filter on.";if(!operator)throw"NoFilters::add requires a operator to filter by.";if(!value)throw"NoFilters::add requires a value(s) to filter for.";this.unshift(new NoFilterExpression(column,operator,value,logic))};var _interface={NoFilterExpression:NoFilterExpression,NoFilters:NoFilters,NoSortExpression:NoSortExpression,NoSort:NoSort,NoPage:NoPage};noInfoPath.data=angular.extend(noInfoPath.data,_interface)}(angular),function(angular,undefined){angular.module("noinfopath.data").service("noOdataQueryBuilder",["$filter",function($filter){function isGuid(val){return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(val)}function toOdataFilter(filters,useOdataFour){var idx,length,field,format,operator,value,ignoreCase,filter,origFilter,result=[];for(idx=0,length=filters.length;length>idx;idx++)filter=origFilter=filters[idx],field=filter.column,value=filter.value,operator=filter.operator,logic=filter.logic,filter.filters?filter=toOdataFilter(filter,useOdataFour):(ignoreCase=filter.ignoreCase,field=field.replace(/\./g,"/"),filter=odataFilters[operator],filter&&value!==undefined&&(angular.isString(value)?(format=isGuid(value)?"guid'{1}'":"'{1}'",value=value.replace(/'/g,"''")):angular.isDate(value)?useOdataFour?format="yyyy-MM-ddTHH:mm:ss+00:00":(value=$filter("date")(value,"DateTime'yyyy-MM-ddT0hh:mm:ss'"),format="{1}"):format="{1}",filter.length>3?"substringof"!==filter?format="{0}({2},"+format+")":(format="{0}("+format+",{2})","doesnotcontain"===operator&&(useOdataFour?(format="{0}({2},'{1}') eq -1",filter="indexof"):format+=" eq false")):format="{2} {0} "+format,filter=$filter("format")(format,filter,value,field))),origFilter.compiledFilter=filter,result.push(origFilter);var f,odataFilter="";do f=result.pop(),odataFilter=odataFilter+"("+f.compiledFilter+")",f.logic?odataFilter=odataFilter+" "+f.logic+" ":f=null;while(f);return odataFilter=odataFilter.trim()}function toOdataSort(sort){var expr,sorts=[];return angular.forEach(sort,function(value){var order=value.column.replace(/\./g,"/");"desc"===value.dir&&(order+=" desc"),sorts.push(order)}),expr=sorts?sorts.join(","):undefined}var odataFilters={eq:"eq",neq:"ne",gt:"gt",gte:"ge",lt:"lt",lte:"le",contains:"substringof",doesnotcontain:"substringof",endswith:"endswith",startswith:"startswith"},mappers={pageSize:angular.noop,page:angular.noop,filter:function(params,filter,useVersionFour){filter&&(params.$filter=toOdataFilter(filter,useVersionFour))},data:function(params,filter,useVersionFour){mappers.filter(params,filter.filter,useVersionFour)},sort:function(params,orderby){var sorts=angular.forEach(orderby,function(value){var order=value.field.replace(/\./g,"/");return"desc"===value.dir&&(order+=" desc"),order}),expr=sorts?sorts.join(","):undefined;expr&&(params.$orderby=expr)},skip:function(params,skip){skip&&(params.$skip=skip)},take:function(params,take){take&&(params.$top=take)}};this.makeQuery=function(){var query={};for(var ai in arguments){var arg=arguments[ai];if(angular.isObject(arg))switch(arg.__type){case"NoFilters":query.$filter=toOdataFilter(arg);break;case"NoSort":query.$orderby=toOdataSort(arg);break;case"NoPage":page=arg}}return query}}])}(angular),function(){"use strict";function MockStorage(){var _store={};Object.defineProperties(this,{length:{get:function(){var l=0;for(var x in _store)l++;return l}}}),this.key=function(i){var l=0;for(var x in _store)if(i==l)return x},this.setItem=function(k,v){_store[k]=v},this.getItem=function(k){return _store[k]},this.removeItem=function(k){delete _store[k]},this.clear=function(){_store={}}}function NoStorage(storetype){var _store;_store="object"==typeof window[storetype]?window[storetype]:new MockStorage,Object.defineProperties(this,{length:{get:function(){return _store.length}}}),this.key=function(i){return _store.key(i)},this.setItem=function(k,v){v?_store.setItem(k,angular.toJson(v)):_store.setItem(k,void 0)},this.getItem=function(k){var x=_store.getItem(k);return"undefined"===x?void 0:angular.fromJson(x)},this.removeItem=function(k){_store.removeItem(k)},this.clear=function(){_store.clear()}}angular.module("noinfopath.data").factory("noSessionStorage",[function(){return new NoStorage("sessionStorage")}]).factory("noLocalStorage",[function(){return new NoStorage("localStorage")}])}(angular),function(angular,undefined){"use strict";angular.module("noinfopath.data").config([function(){}]).provider("noConfig",[function(){function noConfig($http,$q,$timeout,$rootScope,noLocalStorage){var SELF=this;Object.defineProperties(this,{current:{get:function(){return _currentConfig}},status:{get:function(){return _status}}}),this.load=function(uri){var url=uri||"/config.json";return $http.get(url).then(function(resp){noLocalStorage.setItem("noConfig",resp.data)})["catch"](function(err){throw err})},this.fromCache=function(){_currentConfig=noLocalStorage.getItem("noConfig")},this.whenReady=function(uri){var deferred=$q.defer();return $timeout(function(){$rootScope.noConfigReady?deferred.resolve():($rootScope.$watch("noConfigReady",function(newval){newval&&deferred.resolve()}),SELF.load(uri).then(function(){_currentConfig=noLocalStorage.getItem("noConfig"),$rootScope.noConfigReady=!0})["catch"](function(err){SELF.fromCache(),_currentConfig?$rootScope.noConfigReady=!0:deferred.reject("noConfig is offline, and no cached version was available.")}))}),deferred.promise}}var _currentConfig,_status;this.$get=["$http","$q","$timeout","$rootScope","noLocalStorage",function($http,$q,$timeout,$rootScope,noLocalStorage){return new noConfig($http,$q,$timeout,$rootScope,noLocalStorage)}]}])}(angular),function(angular,undefined){"use strict";angular.module("noinfopath.data").provider("noHTTP",[function(){this.$get=["$rootScope","$q","$timeout","$http","$filter","noUrl","noConfig","noDbSchema","noOdataQueryBuilder","noLogService",function($rootScope,$q,$timeout,$http,$filter,noUrl,noConfig,noDbSchema,noOdataQueryBuilder,noLogService){function NoDb(queryBuilder){function configure(tables){var deferred=$q.defer();return $timeout(function(){angular.forEach(tables,function(table,name){this[name]=new NoTable(name,table,queryBuilder)},THIS),deferred.resolve()}),deferred.promise}var THIS=this;this.whenReady=function(){var deferred=$q.defer(),tables=noDbSchema.tables;return $timeout(function(){$rootScope.noHTTPInitialized?(noLogService.log("noHTTP Ready."),deferred.resolve()):($rootScope.$watch("noHTTPInitialized",function(newval){newval&&(noLogService.log("noHTTP ready."),deferred.resolve())}),configure(tables).then(function(resp){$rootScope.noHTTPInitialized=!0})["catch"](function(err){deferred.reject(err)}))}),deferred.promise}}function NoTable(tableName,table,queryBuilder){if(!queryBuilder)throw"TODO: implement default queryBuilder service";var url=noUrl.makeResourceUrl(noConfig.current.RESTURI,tableName);this.noCreate=function(data){var json=angular.toJson(data),deferred=$q.defer(),req={method:"POST",url:url,data:json,headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0};return $http(req).success(function(data){deferred.resolve(data)}).error(function(reason){console.error(reason),deferred.reject(reason)}),deferred.promise},this.noRead=function(){noLogService.debug("noRead say's, 'swag!'");var filters,sort,page;for(var ai in arguments){var arg=arguments[ai];if(angular.isObject(arg))switch(arg.constructor.name){case"NoFilters":filters=arg;break;case"NoSort":sort=arg;break;case"NoPage":page=arg}}var deferred=$q.defer(),req={method:"GET",params:queryBuilder(filters,sort,page),url:url,headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0};return $http(req).success(function(data){deferred.resolve(data.value)}).error(function(reason){noLogService.error(arguments),deferred.reject(reason)}),deferred.promise},this.noUpdate=function(data){var json=angular.toJson(data),deferred=$q.defer(),req={method:"PUT",url:url+"(guid'"+data[table.primaryKey]+"')",data:json,headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0};return $http(req).success(function(data,status){deferred.resolve(status)}).error(function(reason){console.error(reason),deferred.reject(reason)}),deferred.promise},this.noDestroy=function(data){var deferred=$q.defer(),req={method:"DELETE",url:url+"(guid'"+data[table.primaryKey]+"')",headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0};return $http(req).success(function(data,status){deferred.resolve(status)}).error(function(reason){console.error(reason),deferred.reject(reason)}),deferred.promise}}return new NoDb(noOdataQueryBuilder.makeQuery)}]}])}(angular),function(angular,Dexie,undefined){"use strict";angular.module("noinfopath.data").factory("noDbSchema",["$q","$timeout","$http","$rootScope","lodash","noLogService",function($q,$timeout,$http,$rootScope,_,noLogService){function NoDbSchema(){function _processDbJson(resp){var deferred=$q.defer();return _tables=resp.data,$timeout(function(){angular.forEach(_tables,function(table,tableName){var primKey="$$"+table.primaryKey,foreignKeys=_.uniq(_.pluck(table.foreignKeys,"column")).join(",");_config[tableName]=primKey+(foreignKeys?","+foreignKeys:"")}),deferred.resolve()}),deferred.promise}function load(){var req={method:"GET",url:"/db.json",headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0};return $http(req).then(_processDbJson)["catch"](function(resp){noLogService.error(resp)})}Object.defineProperties(this,{store:{get:function(){return _config}},tables:{get:function(){return _tables}},isReady:{get:function(){return _.size(_tables)>0}}}),this.whenReady=function(){var deferred=$q.defer();return $timeout(function(){$rootScope.noDbSchemaInitialized?(noLogService.log("noDbSchema Ready."),deferred.resolve()):($rootScope.$watch("noDbSchemaInitialized",function(newval){newval&&(noLogService.log("noDbSchema ready."),deferred.resolve())}),load().then(function(resp){$rootScope.noDbSchemaInitialized=!0})["catch"](function(err){deferred.reject(err)}))}),deferred.promise}}var _interface=new NoDbSchema,_config={},_tables={};return _interface}])}(angular,Dexie),function(angular,Dexie,undefined){"use strict";angular.module("noinfopath.data").service("noBulkData",["$q","$timeout","noConfig","noUrl","noDexie","noLogService",function($q,$timeout,noConfig,noUrl,noDexie,noLogService){function BulkImportProgress(){var _proto_=Object.getPrototypeOf(this);this.tables=new noInfoPath.ProgressTracker,this.rows=new noInfoPath.ProgressTracker,_proto_.changeTableMessage=function(msg,css,showProgress,deferred){$timeout(function(){this.tables.changeMessage(msg,showProgress),this.tables.changeCss(css),deferred.notify(this)}.bind(this))},_proto_.changeRowMessage=function(msg,css,showProgress,deferred){$timeout(function(){this.rows.changeMessage(msg,showProgress),this.rows.changeCss(css),deferred.notify(this)}.bind(this))},_proto_.updateTable=function(msg,css,deferred){$timeout(function(){this.tables.update(msg),this.tables.changeCss(css),deferred.notify(this)}.bind(this))},_proto_.updateRow=function(msg,css,deferred){$timeout(function(){this.rows.update(msg),this.rows.changeCss(css),deferred.notify(this)}.bind(this))}}var csss={success:"progress-bar-success progress-bar-striped active",info:"progress-bar-info progress-bar-striped active",warning:"progress-bar-warning"};this.load=function(noManifest,datasvc){function _queue(manifest){for(var k in manifest){var task=manifest[k];task.url=k,_tasks.push(task)}}function _recurse(deferred,progress){var table,remote,task=_tasks.shift();if(task){if(progress.updateTable("Downloading "+task.TableName,csss.success,deferred),noLogService.debug(noDexie.constructor.name),noLogService.debug(_datasvc.constructor.name),table=noDexie[task.url],remote=_datasvc[task.url],!table||!remote)throw{message:"table or remote not so swag!",data:[table,remote]};remote.noRead().then(function(data){try{data?(progress.changeTableMessage("Importing "+data.length+" items from "+task.TableName,csss.info,!1,deferred),noDexie[task.url].bulkLoad(data,progress).then(function(info){deferred.notify(progress),_recurse(deferred,progress)})["catch"](function(err){deferred.notify(progress),_recurse(deferred,progress)})["finally"](angular.noop,function(info){deferred.reject(progress)})):(progress.rows.start({min:1,max:1,showProgress:!1}),progress.updateRow("Error downloading "+task.TableName,csss.warning,deferred),deferred.notify(progress),_recurse(deferred,progress))}catch(ex){deferred.reject(ex)}})["catch"](function(err){progress.rows.start({min:1,max:1,showProgress:!1}),progress.updateRow("Error downloading "+task.TableName,csss.warning),deferred.notify(progress),_recurse(deferred,progress)})}else deferred.resolve()}var _datasvc,_tasks=[],deferred=$q.defer(),progress=new BulkImportProgress;return _datasvc=datasvc,_queue(noManifest),_recurse(deferred,progress),deferred.promise}.bind(this)}])}(angular,Dexie),function(angular,Dexie,undefined){"use strict";angular.module("noinfopath.data").factory("noDexie",["$timeout","$q","$rootScope","lodash","noLogService",function($timeout,$q,$rootScope,_,noLogService){function noDatum(){noLogService.log("noDatum::constructor")}function noDexie(db){db.WriteableTable.prototype.noCreate=function(data){var deferred=$q.defer(),table=this;return _dexie.transaction("rw",table,function(){data.CreatedBy=_dexie.currentUser.userId,data.DateCreated=new Date(Date.now()),data.ModifiedDate=new Date(Date.now()),data.ModifiedBy=_dexie.currentUser.userId,table.add(data).then(function(data){noLogService.log("addSuccessful",data),table.get(data).then(function(data){window.noInfoPath.digest(deferred.resolve,data)})["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)})})["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)})}).then(function(){noLogService.log("transaction successful for Create")})["catch"](function(err){deferred.reject("noCRUD::createTrans "+err),window.noInfoPath.digestError(deferred.reject,err)}),deferred.promise},db.Table.prototype.noRead=function(){function _applyFilters(iNoFilters,store){var deferred=$q.defer(),iNoFiltersHash=_sortOutFilters(iNoFilters);return iNoFilters?_recurseIndexedFilters(iNoFiltersHash.indexedFilters,table).then(function(data){deferred.resolve(new NoResults(data))})["catch"](function(err){deferred.reject(err)}):table.toArray().then(deferred.resolve)["catch"](deferred.reject),deferred.promise}function _recurseIndexedFilters(filters,table){function _reduce(map){var keys=[],all=[],results=[];for(var k in map){var items=map[k];switch(items.filter.logic){case"or":keys=_.union(keys,_.pluck(items.data,"pk"));break;case"and":keys=_.intersection(keys,_.pluck(items.data,"pk"));break;default:keys=keys.concat(_.pluck(items.data,"pk"))}all=_.union(all,items.data)}for(var ka in all){var item=all[ka].obj,key=item[table.schema.primKey.name];keys.indexOf(key)>-1&&results.push(item)}return results}function _map(){var promise,filter=filters.pop();filter?(promise=table.schema.primKey===filter.column?_filterByPrimaryKey(filter,table):_filterByIndex(filter,table),promise.then(function(data){map[filter.column]={pk:table.schema.primKey.name,filter:filter,data:data},_map()})["catch"](function(err){noLogService.error(err)})):deferred.resolve(_reduce(map))}var deferred=$q.defer(),map={};return $timeout(_map),window.noInfoPath.digestTimeout(),deferred.promise}function _filterByPrimaryKey(filter,store){var deferred=$q.defer(),req=store.openKeyCursor(),operator=operators[filter.operator],matchedKeys=[];return req.onsuccess=function(event){var cursor=event.target.result;cursor?(operator(cursor.key,filter.value)&&matchedKeys.push(cursor.primaryKey),cursor["continue"]()):deferred.resolve(matchedKeys)},req.onerror=function(){deferred.reject(req.error)},deferred.promise}function _filterByIndex(filter,table){var deferred=$q.defer(),operator=operators[filter.operator],matchedKeys=[];return table._idbstore("readonly",function(resolve,reject,store,trans){var ndx=store.index(filter.column),req=ndx.openCursor();req.onsuccess=function(event){var cursor=event.target.result;cursor?(operator(cursor.key,filter.value)&&matchedKeys.push({pk:cursor.primaryKey,fk:cursor.key,obj:cursor.value}),cursor["continue"]()):resolve(matchedKeys)},req.onerror=function(event){reject(event)},trans.on("complete",function(event){deferred.resolve(matchedKeys)}),trans.on("error",function(event){deferred.reject(trans.error())})}),deferred.promise}function _filterHasIndex(iNoFilterExpression){return _.findIndex(table.schema.indexes,{keyPath:iNoFilterExpression.column})>-1}function _sortOutFilters(iNoFilters){var iNoFilterHash={indexedFilters:[],nonIndexedFilters:[]};return angular.forEach(iNoFilters,function(iNoFilterExpression){table.schema.primKey.keyPath===iNoFilterExpression.column?iNoFilterHash.indexedFilters.push(iNoFilterExpression):_filterHasIndex(iNoFilterExpression)?iNoFilterHash.indexedFilters.push(iNoFilterExpression):iNoFilterHash.nonIndexedFilters.push(iNoFilterExpression)}),iNoFilterHash}function _applyPaging(page,data){return $q(function(resolve,reject){data.page(page),resolve(data)})}var filters,sort,page,deferred=$q.defer(),table=this,operators={"in":function(a,b){return _.indexOf(b,a)>-1},eq:function(a,b){return a===b},neq:function(a,b){return a!==b},gt:function(a,b){return a>b},ge:function(a,b){return a>=b},lt:function(a,b){return b>a},le:function(a,b){return b>=a},startswith:function(a,b){var a1=a?a.toLowerCase():"",b1=b?b.toLowerCase():"";return 0===a1.indexOf(b1)},contains:function(a,b){var a1=a?a.toLowerCase():"",b1=b?b.toLowerCase():"";return a1.indexOf(b1)>=-1}};for(var ai in arguments){var arg=arguments[ai];if(angular.isObject(arg))switch(arg.constructor.name){case"NoFilters":filters=arg;break;case"NoSort":sort=arg;break;case"NoPage":page=arg}}return $timeout(function(){_applyFilters(filters,table).then(_applyPaging)["catch"](function(err){deferred.reject(err)})}),window.noInfoPath.digestTimeout(),deferred.promise},db.WriteableTable.prototype.noUpdate=function(data){var deferred=$q.defer(),table=this,key=data[table.noInfoPath.primaryKey];return _dexie.transaction("rw",table,function(){data.ModifiedDate=new Date(Date.now()),data.ModifiedBy=_dexie.currentUser.userId,table.update(key,data).then(function(data){window.noInfoPath.digest(deferred.resolve,data)})["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)})}).then(angular.noop())["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)}),deferred.promise},db.WriteableTable.prototype.noDestroy=function(data){var deferred=$q.defer(),table=this,key=data[table.noInfoPath.primaryKey];return noLogService.log(key),_dexie.transaction("rw",table,function(){table["delete"](key).then(function(data){window.noInfoPath.digest(deferred.resolve,data)})["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)})}).then(angular.noop())["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)}),deferred.promise},db.WriteableTable.prototype.noOne=function(data){var deferred=$q.defer(),table=this,key=data[table.noInfoPath.primaryKey];return _dexie.transaction("r",table,function(){table.get(key).then(function(data){window.noInfoPath.digest(deferred.resolve,data)})["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)})}).then(angular.noop())["catch"](function(err){window.noInfoPath.digestError(deferred.reject,err)}),deferred.promise},db.WriteableTable.prototype.bulkLoad=function(data,progress){function _import(data,progress){function _next(){if(currentItem<data.length){var datum=data[currentItem];table.add(datum).then(function(){deferred.notify()})["catch"](function(err){deferred.reject(err)})["finally"](function(){currentItem++,_next()})}else deferred.resolve(table.name)}data?data.length:0;$timeout(function(){deferred.notify(progress)});var currentItem=0;_dexie.transaction("rw",table,function(){_next()})}var deferred=$q.defer(),table=this;return table.clear().then(function(){_import(data,progress)}.bind(this)),deferred.promise}}function _extendDexieTables(dbSchema){function _toDexieClass(tsqlTableSchema){var _table={};return angular.forEach(tsqlTableSchema.columns,function(column,tableName){switch(column.type){case"uniqueidentifier":case"nvarchar":case"varchar":_table[tableName]="String";break;case"date":case"datetime":_table[tableName]="Date";break;case"bit":_table[tableName]="Boolean";break;case"int":case"decimal":_table[tableName]="Number"}}),_table}angular.forEach(dbSchema,function(table,tableName){var dexieTable=_dexie[tableName];dexieTable.mapToClass(noDatum,_toDexieClass(table)),dexieTable.noInfoPath=table})}Dexie.prototype.configure=function(noUser,dbVersion,dexieStores,dbSchema){var deferred=$q.defer();return $timeout(function(){_dexie.currentUser=noUser,_dexie.on("error",function(err){noLogService.error("Dexie Error: "+err),window.noInfoPath.digestError(deferred.reject,err)}),_dexie.on("blocked",function(err){noLogService.warn("IndedexDB is currently execting a blocking o`peration."),window.noInfoPath.digestError(deferred.reject,err)}),_dexie.on("versionchange",function(err){noLogService.error("IndexedDB as detected a version change")}),_dexie.on("populate",function(err){noLogService.warn("IndedexDB populate...  not implemented.")}),_dexie.on("ready",function(data){noLogService.log("Dexie ready"),$rootScope.noIndexedDBReady=!0,window.noInfoPath.digest(deferred.resolve,data)}),_dexie.isOpen()?$timeout(function(){window.noInfoPath.digest(deferred.resolve)}):_.size(dexieStores)?(_dexie.version(dbVersion.version).stores(dexieStores),_extendDexieTables.call(_dexie,dbSchema),_dexie.open()):noLogService.warn("Waiting for noDbSchema data.")}),window.noInfoPath.digestTimeout(),deferred.promise},Dexie.prototype.whenReady=function(){var deferred=$q.defer();return $timeout(function(){$rootScope.noIndexedDBReady?deferred.resolve():$rootScope.$watch("noIndexedDBReady",function(newval){newval&&deferred.resolve()})}),deferred.promise},Dexie.addons.push(noDexie);var _dexie=new Dexie("NoInfoPath-v3");return _dexie}])}(angular,Dexie);